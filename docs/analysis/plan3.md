# Refactoring Plan 3: Slug-Based Folder Naming & Output Cache Management

## Motivation & Goals

- **Consistency:** Ensure every agent run folder is named using the LLM-based slug generator, making output organization deterministic, readable, and traceable to the user query.
- **Automation:** Eliminate the need for handwritten or manually specified folder names for agent runs.
- **Centralized Output Cache:** Introduce a `.cache` directory to store all outputs (scraped content, answers, summaries, etc.) in a structured, query-slug-based manner.
- **Reusability & Efficiency:** Enable the agent to reuse cached outputs for repeated or similar queries, reducing redundant computation and API calls.
- **Traceability:** Make it easy to find, review, and audit all outputs for any given query or run.

---

## What Will Change

1. **Slug-Based Folder Naming:**
   - All agent run folders will be named using the LLM-based slug generator (as in `generate_query_slug`).
   - No more manual or arbitrary folder names for outputs.
   - The slug generator will be the single source of truth for run folder naming.

2. **.cache Directory for Outputs:**
   - All outputs (scraped content, answers, summaries, etc.) will be stored under a top-level `.cache` directory.
   - Each run will have its own subfolder named by the generated slug (with a numeric suffix for uniqueness if needed).
   - The `.cache` directory will serve as the persistent knowledge base for all agent runs.

3. **Automated Folder Management:**
   - The agent will automatically create and manage run folders inside `.cache`.
   - Manual folder naming or specification will be discouraged and only allowed for advanced/override use cases.

---

## Concrete Steps

1. **Refactor Output Folder Logic:**
   - Update all workflow entry points (e.g., `run_search_and_synthesize_workflow`, `multi_agentic_search_scrape_answer`) to use the slug generator for every run.
   - Remove or deprecate any code paths that allow manual folder naming by default.
   - Ensure the slug generator always produces a valid, unique folder name inside `.cache`.

2. **Implement .cache Directory:**
   - Create a `.cache` directory at the project root if it does not exist.
   - All run outputs (scraped content, answers, summaries, etc.) will be saved under `.cache/{slug}/`.
   - Update all file path logic to use `.cache` as the parent directory.

3. **Cache Lookup & Reuse (Optional/Advanced):**
   - Before running a new agent workflow, check if a folder for the same slug already exists in `.cache`.
   - If so, allow the agent to reuse or reference previous outputs (configurable).
   - This can be extended to support cache invalidation, versioning, or merging in the future.

4. **Documentation & Best Practices:**
   - Update documentation to reflect the new output structure and cache management.
   - Clearly state that folder names are always generated by the agent, not handwritten.
   - Provide guidelines for advanced users who may want to override this behavior.

---

## Best Practices

- **Single Source of Truth:** The slug generator is the only way to name run folders. This ensures consistency and traceability.
- **No Manual Folder Names:** Avoid handwritten or arbitrary folder names except for advanced/manual override scenarios.
- **Centralized Cache:** All outputs live in `.cache`, making it easy to manage, backup, or analyze all agent knowledge.
- **Extensibility:** The cache structure can be extended to support new output types, cache policies, or integrations (e.g., LlamaIndex).
- **Auditability:** Every run is traceable to its query via the slug, and all outputs are easy to find and review.

---

## Example Output Structure

```
.cache/
  beekeeping_lora_open_source_monitoring_solar_sensors_audio_1/
    final_answer.md
    all_iteration_answers.md
    scraped_content/
      *.md
    run_summary.json
  como_me_tornar_advogado_em_portugal_1/
    ...
```

---

## Future Considerations

- **Cache Invalidation:** Add mechanisms to clear or update cache entries as needed.
- **Versioning:** Support versioned outputs for the same query if the agent logic changes.
- **Integration:** Make `.cache` compatible with downstream tools (e.g., LlamaIndex ingestion, analytics, etc.).
- **User Overrides:** Allow advanced users to specify custom output locations, but document this as a non-default, expert feature. 